# 実例集

調査レポートで使える具体的な記述例。

## 過去の議論の引用

```markdown
## プロモコード自動適用の仕組みがある

- 以下のチケットで実装された機能
  - 過去のチケット#567
- ABテスト用のプロモコードがあるらしい
- いずれのプロモコードも`2019年期限` だったので不要な仕組みだと思われる

**対応方針:**

- 👉自動適用の仕組みは実質的にデッドコードなので撤去する
```

## デッドコードの特定

```markdown
## `data_summary` テーブルの利用目的と関係者

- 管理画面の`売上レポート`からダウンロードできるCSVファイルのローデータとして参照されている
- 主なステークホルダーは経理チームだが、過去に確認したところ誰も使ってない機能ということになり、月次レポート機能を停止したらしい
  - 過去の議論へのリンク
- しかし、`data_summary`を生成する`generate_summary.rb` はまだ動き続けている状況（== 無意味なデータ生成）
- 👉将来的に撤去予定
```

## 段階的な対応方針

```markdown
## リプレース方針

- リプレース作業を段階的に実施する
  - `Order.promo` の参照箇所を個別に`Order.promos`にリプレース
  - `Order.promo`の参照箇所がなくなったら撤去
- テスト方法を現実的な範囲に調整
  - 複数プロモコードデータではテストしない
  - 単一プロモコードでテストする
  - `Order.promo` を撤去したら複数プロモコードデータで再度テストする
```

## 実装工数の比較

```markdown
## `完全撤去 OR コード修正`の工数感

- 撤去するにしてもアナウンス調整や撤去作業、古いクライアントでの挙動調査などで時間が掛かりそう
  - 過去の議論へのリンク
- コード修正で検討してみる

**対応方針:**

- 👉コード修正の方が現実的
```

## 動作確認の記録

```markdown
## getUserPromoSummary メソッド

- 👉対応不要だった
- ソースコード
  - [src/services/promo_service.rb#L153](リポジトリへのリンク)
- メソッドの役割
  - プロモコード利用された注文数をカウントしている
  - `promos → orders` でJOINしているが現状のままでも動作に問題なし
- 動作テスト
  - 管理画面の`プロモコード管理 > 詳細`にアクセスして、利用件数を正しくカウントできていることを確認
  - テスト環境URL: https://admin.test.example.com/promos/123
    <img width="500" alt="動作確認スクリーンショット" src="...">
```

## ER図を使った関係性の整理

```markdown
## `data_summary` テーブルの利用目的と関係者

- 管理画面の`売上レポート`からダウンロードできるCSVファイルのローデータとして参照されている

    ```mermaid
    erDiagram
        report_templates（レポートテンプレート） |o--o{ data_summary（データ集計：単位毎） : "1:n"
    ```

- 主なステークホルダーは経理チームだが、過去に確認したところ誰も使ってない機能ということになり、月次レポート機能を停止したらしい
  - 過去の議論へのリンク

**対応方針:**

- 👉将来的に撤去予定だが、不整合なクエリを残したくないので修正しておく
```

## 将来的な撤去予定機能への対応

```markdown
## `data_summary` テーブルの利用状況

- 👉将来的に撤去予定とのことだが、不整合なクエリが残っていると煩わしいので修正しておく
  - 過去の議論へのリンク

## 対応方針

- 撤去予定の機能・テーブルだが、不整合なクエリを残したくないので修正しておく
  - `LEFT OUTER JOIN`ではなく、`条件付きのLEFT OUTER JOIN`に書き換える
  - `payment_amount` の計算で複数プロモコードの金額を減算できるようにする
```

## メールテンプレートの調査

```markdown
## メールテンプレート

- テンプレートID: 510

    ```sql
    SELECT *
    FROM email_templates
    WHERE template_id = 510;
    ```

    結果:
    
    ```json
    [{
      "template_id": 510,
      "subject": "Data integrity check results",
      "body": "Invalid data list:\n\n{{invalid_promo_data}}\n\n..."
    }]
    ```

## 対応方針

- メールテンプレートの修正
  - `{{invalid_promo_data}}` プレースホルダーを撤去
  - 関連チケットリストに今回の作業チケットを追加
```

---

## アンチパターン

### ❌ 推測のみで結論

```markdown
# 悪い例
「このAPIは使われていないと思うので撤去できる」
```

**改善**: BigQueryやRedashで実際のアクセス状況を確認

### ❌ コードリンクがない

```markdown
# 悪い例
「CartControllerで問題がある」
```

**改善**: GitLabの行番号付きリンクを提示

### ❌ 対応方針が曖昧

```markdown
# 悪い例
「何らかの対応が必要」
```

**改善**: 👉で具体的な対応方針を明示

### ❌ 過去の経緯が不明

```markdown
# 悪い例
「この機能がある」
```

**改善**: チケット番号、実装時期、実装理由を調査して記載
