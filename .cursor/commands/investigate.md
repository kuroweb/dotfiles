---
description: 既存コードを調査し、原因分析・改善案・実装方針を含む詳細レポートを作成します。バグ調査、機能理解、パフォーマンス分析に使用。
---

# 調査コマンド

このコマンドは**code-investigator**エージェントを呼び出し、既存コードを体系的に調査して詳細なレポートを作成します。

## このコマンドの機能

1. **調査範囲の明確化** - 調査対象と目的を確認
2. **体系的なコード探索** - Grep、Glob、SemanticSearchを活用
3. **原因分析** - 問題の根本原因を特定
4. **改善案の提示** - 具体的な解決策とトレードオフを提示
5. **実装方針の策定** - 段階的な実装計画を作成
6. **構造化レポート** - 可視化とデータで裏付けられた報告

## 使用するタイミング

`/investigate`を使用する場合:

- バグの原因を特定したいとき
- 既存機能の仕様を理解したいとき
- パフォーマンス問題を分析したいとき
- アーキテクチャを理解したいとき
- リファクタリング前の影響調査をするとき
- 新規機能開発で既存機能との連携を調べるとき
- データ整合性を確認したいとき
- デッドコードを特定したいとき

## 動作の仕組み

code-investigatorエージェントは以下を行います:

1. **調査依頼を分析**し、調査目的・範囲・成功基準を確認
2. **調査計画を策定**し、使用するツールと手順を決定
3. **コードベースを探索**し、関連情報を収集
4. **データを分析**し、パターンや問題を特定
5. **レポートを作成**し、可視化と具体的な推奨事項を含める

## 使用例

### テーブル移行に伴うレガシーAPI調査

```
ユーザー: /investigate 旧カートAPIのテーブル参照を調査して新方式への移行方針を決めたい

エージェント (code-investigator):
# 目的

- [#12345 テーブル移行に伴うレガシーAPIの調査](チケットリンク)

# 調査ログ

## アクセス状況を調査

- BigQuery

    ```sql
    SELECT _TABLE_SUFFIX AS date, COUNT(*) AS cnt
    FROM `project.dataset.table_*`
    WHERE _TABLE_SUFFIX BETWEEN '20260101' AND '20260110'
      AND path LIKE '%/api/cart/add%'
    GROUP BY date
    ```

    結果: 10日間で11件のアクセス

**対応方針:**

- 👉撤去よりもコード修正の方が現実的

## `/api/cart/add` について

- [app/controllers/api/legacy_controller.rb#L88-101](リポジトリへのリンク)
- プロモコード自動適用の仕組みがあるが、すべて期限切れでデッドコード

**対応方針:**

- 👉`SELECT, UPDATE`の向け先テーブルを新方式に切り替える
- 👉デッドコードを撤去する

## 対応方針まとめ

- デッドコードを撤去
- SELECT/UPDATEの向け先を新方式テーブルに変更
```

### テーブル移行に伴うJOIN処理の影響調査

```
ユーザー: /investigate テーブル移行でJOIN処理への影響を確認したい

エージェント (code-investigator):
# 目的

- [#5678 テーブル移行に伴うJOIN処理の影響調査](チケットリンク)

# 調査ログ

## calculateUserSummary メソッド

- 👉対応不要だった
- [src/services/report_service.rb#L153](リポジトリへのリンク)
- `table_a → table_b` でJOINしているが現状のままで動作に問題なし
- 動作テスト: 管理画面で集計値の表示を確認

## getDataList メソッド

- 👉対応不要だった
- [src/services/report_service.rb#L266](リポジトリへのリンク)
- JOIN処理は現状のままで問題なし

## 対応方針まとめ

- すべてのメソッドで現状のままで動作に問題なし
- 👉一部で無駄なJOINがあるが、パフォーマンス影響は軽微なため優先度は低い
```

### 複数割引コード適用時のエラー調査

```
ユーザー: /investigate 複数割引コード適用時に詳細画面でエラーになる

エージェント (code-investigator):
# 目的

- [#9012 Multiple discount codes causing errors](チケットリンク)

# 調査ログ

## 複数割引コード適用時に詳細画面でエラーになる

- `Order → Discount` のアソシエーション定義が原因
- [src/models/Order.java#L176-178](リポジトリへのリンク)
- ORMは`Discount`が1件を期待するのに2件以上返却されてエラー

## リプレース方針

- アソシエーション定義を`Order.discount → Order.discounts`にリプレース
- 段階的な実施:
  - `Order.discount`の参照箇所を個別に`Order.discounts`にリプレース
  - 参照箇所がなくなったら撤去
- テスト方法:
  - 撤去までは単一割引コードでテスト
  - 撤去後に複数割引コードデータで再テスト

**対応方針:**

- 👉段階的なリプレースにより安全に移行
```

## 重要な注意事項

**推奨される使い方:**

- 調査依頼は具体的に（例: 「決済金額が0.01円ずれる問題」）
- 調査範囲を明確に（例: 「payment_service.rbの手数料計算部分」）
- 期待する成果物を指定（例: 「原因特定のみ」「修正案まで」「実装計画まで」）
- 関連チケット番号があれば提示

**エージェントの動作:**

- 最初に調査目的・範囲・成功基準を確認
- 必要に応じて追加情報を質問
- データベースクエリを実際に実行して結果を確認
- アクセスログを分析（BigQuery等）
- 過去の議論を追跡（Slack、チケット）
- コードへの直接リンク（行番号付き）を提示
- 調査結果を構造化されたレポート形式で報告
- 各調査項目に👉で対応方針を明示
- データと証拠で裏付けられた推奨事項を提示

## 他のコマンドとの統合

調査完了後:

- `/plan` - 調査結果を基に実装計画を作成
- `/tdd` - テスト駆動で修正を実装
- `/code-review` - 修正案のセキュリティレビュー
- `/e2e` - 修正後のE2Eテスト実行

## 関連エージェント

このコマンドは以下にある`code-investigator`エージェントを呼び出します:
`.cursor/agents/code-investigator.md`
