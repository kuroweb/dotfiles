---
description: 既存機能の調査を実施する際に実行してください
globs: ["**/*"]
triggers: ["既存調査！！！"]
---

# 既存機能調査ガイドライン

## 開始確認マジックワード

このファイルが参照された際は、必ず最初に以下の形式で出力すること。これは既存機能調査プロセス開始の確認マジックワードである。

- `💡💡💡💡既存機能調査を開始します💡💡💡💡`

## 目的

既存機能の調査を実施し、以下のドキュメントを作成するためのガイドライン。

- 機能の全体像を理解する
- データフローとテーブル構造を整理する
- ユースケースを詳細に記述する
- エッジケースや手動対応が必要なケースを明記する
- 関連ファイルへのリンクを含める

## 調査の実施手順

以下、既存機能調査時は絶対に守ってください。

- 「1. 調査開始前の確認 → 2. 機能の全体像を把握 → 3. ユースケースの詳細調査 → 4. エッジケース・運用対応の調査 → 5. コードベースの調査」の順で、作業が実施されるよう、ガイドしてください。
- 各工程で、調査内容に問題がないかを必ずユーザーに確認を入れてから次に進むようにしてください。

## 1. 調査開始前の確認

### 💡 Cursor Prompt : PRE_INVESTIGATION_CHECK

**調査を開始する前に、必ずユーザーに以下を確認すること:**

1. **調査対象の機能名を明確にする**
   - どの機能を調査するか
   - 機能名が不明確な場合は、関連するキーワードやテーブル名を確認

2. **調査の目的を確認する**
   - 新規機能開発のための調査か
   - 既存機能の改修のための調査か
   - ドキュメント化のための調査か

3. **調査範囲を確認する**
   - 全体像の把握のみか
   - 特定のユースケースに絞るか
   - エッジケースまで含めるか

⚠️確認が完了してから調査を開始すること

### 調査が必要なケース

- 新規機能開発で既存機能との連携が必要な場合
- 既存機能の改修・改善を行う場合
- 既存機能の動作確認・検証が必要な場合
- 既存機能のドキュメント化が必要な場合

### 調査の優先順位

1. **直接関連する機能**: 新規機能と直接連携する既存機能
2. **類似機能**: 新規機能と類似した既存機能（参考になる実装パターン）
3. **基盤機能**: 複数の機能で共通利用される基盤機能

## 2. 機能の全体像を把握

### 💡 Cursor Prompt : OVERVIEW_INVESTIGATION

調査項目:

- **サービス概要**
  - サービス名
  - 基本コンセプト
  - 目的・背景
  - 提供元・ステークホルダー
  - 特徴・制約

- **ビジネスフロー**
  - エンドツーエンドのフロー
  - 各ステップの説明
  - ステークホルダーごとの役割

- **データフロー**
  - 主要テーブルとその関係
  - データの流れ（mermaid図推奨）
  - ステータス遷移

出力形式:

`plan/{機能名}_既存調査/{機能名}_既存調査.md` を作成し、以下の構造で記述:

```markdown
# {機能名} 既存調査

# 概要

## サービス概要

{サービスの説明}

- **サービス名**: {名前}
- **提供元**: {提供元}
- **目的**: {目的}
- **特徴**: {特徴}

## ステークホルダー

| 役割 | 説明 |
|------|------|
| {役割} | {説明} |

## 仕組み

```

{フローの説明}

```


## データフロー

{mermaid図}

{ステータス遷移の説明}
```

## 3. ユースケースの詳細調査

### 💡 Cursor Prompt : USE_CASE_INVESTIGATION

調査項目:

- **アクターの特定**
  - ユーザー、システム、外部サービス、管理者など

- **ユースケースの洗い出し**
  - 主要なユースケースを列挙
  - 各ユースケースの前提条件、処理内容、事後条件を記述

- **処理フローの詳細**
  - 各ユースケースの処理ステップ
  - 関連するテーブル操作（CREATE/READ/UPDATE/DELETE）
  - 関連するファイル・クラス・メソッドへのリンク

- **テーブル構造の整理**
  - 主要テーブルの役割
  - カラムの説明
  - テーブル間の関係（ER図推奨）

出力形式:

同じファイル内に「ユースケース整理」セクションを追加:

```markdown
# ユースケース整理

## アクター

- {アクター名}: {説明}

## UC-{番号}: {ユースケース名}

- アクター: {アクター}
- 前提: {前提条件}
- 処理内容:
  - {処理ステップ1}
  - {処理ステップ2}
  - {関連ファイルへのリンク}

| テーブル | 操作 | 説明 |
|---------|------|------|
| {テーブル名} | {操作} | {説明} |

## テーブル一覧と役割

| テーブル | 役割 |
|---------|------|
| {テーブル名} | {役割} |

## ER図

{mermaid ER図}
```

## 4. エッジケース・運用対応の調査

### 💡 Cursor Prompt : EDGE_CASE_INVESTIGATION

調査項目:

- **エッジケースの洗い出し**
  - 異常系の処理
  - エラーケース
  - 境界値の扱い

- **手動対応が必要なケース**
  - 自動化されていない処理
  - 運用チームが対応するケース
  - 対応フローと判断基準

- **エラーハンドリング**
  - エラー検知方法
  - エラー通知方法
  - エラー対応フロー

出力形式:

同じファイル内に「オペレーション対応ケース」セクションを追加:

```markdown
# オペレーション対応ケース

## 概要

{概要説明}

## {ケース番号}: {ケース名}

{症状の説明}

{検知方法}

対応フロー:

```

{対応フローの説明}

```


{金額への影響}

関連テーブル:

- {テーブル名}
```

## 5. コードベースの調査

### 💡 Cursor Prompt : CODEBASE_INVESTIGATION

調査方法:

- **codebase_search を使用**
  - 機能名、テーブル名、主要な概念で検索
  - 関連するファイルを特定

- **grep を使用**
  - テーブル名、クラス名、メソッド名で検索
  - 使用箇所を特定

- **ファイルを読む**
  - 関連するモデル、コントローラー、サービス、バッチを読む
  - 処理の流れを理解

調査対象:

- **モデル（app/models/）**
  - テーブル定義
  - バリデーション
  - アソシエーション
  - ビジネスロジック

- **コントローラー（app/controllers/）**
  - API エンドポイント
  - リクエスト処理
  - レスポンス処理

- **サービス（app/services/）**
  - ビジネスロジック
  - 複雑な処理

- **バッチ（app/batches/）**
  - 定期実行処理
  - バックグラウンド処理

- **SQL（app/sqls/）**
  - 複雑なクエリ
  - パフォーマンス重視の処理

出力形式:

調査結果は各ドキュメントに以下の形式で記述:

```markdown
### 関連ファイル

- [{ファイルパス}]({GitLab URL}) - {説明}
- [{ファイルパス}]({GitLab URL}) - {説明}
```

## ドキュメント作成のベストプラクティス

### 構造化

- 見出しレベルを適切に使用（h1〜h3まで）
- 箇条書きで簡潔に記述
- 表を活用して情報を整理

### 可視化

- **mermaid図**を使用
  - データフロー図（graph TD）
  - ER図（erDiagram）
  - シーケンス図（sequenceDiagram）
  - ユースケース相関図（graph TB）

### リンク

- **GitLabへのリンク**を含める
  - ファイルパス: `[{ファイルパス}]({GitLab URL})`
  - 行番号指定: `[{ファイルパス}#L{行番号}]({GitLab URL}#L{行番号})`

- **関連ドキュメントへのリンク**
  - 外部ドキュメント（esa、Redmine、Lookerなど）

### 具体例

- コード例は簡潔に
- 実際のデータ例を含める
- エラーメッセージやログの例を含める

### 注意事項

- **Markdown記述ルールに従う**
  - markdown-style.mdc

## 調査完了の確認項目

- [ ] サービス概要が明確に記述されている
- [ ] ステークホルダーが明確に特定されている
- [ ] データフローが図で可視化されている
- [ ] 主要なユースケースが網羅されている
- [ ] 各ユースケースの処理フローが詳細に記述されている
- [ ] 関連テーブルとその操作が明確に記述されている
- [ ] ER図が作成されている
- [ ] エッジケースが洗い出されている
- [ ] 手動対応が必要なケースが明確に記述されている
- [ ] 関連ファイルへのリンクが含まれている
- [ ] コード例や具体例が含まれている

## 調査時の注意点

### コードベースの調査

- **最新のコードを確認する**
  - developブランチの最新コードを確認
  - 古いコメントやドキュメントは参考程度に

- **実装と仕様の差異を確認する**
  - 仕様書と実装が異なる場合がある
  - 実装を優先して記述する

- **関連する機能も調査する**
  - 依存関係のある機能
  - 類似機能（参考になる実装パターン）

### ドキュメントの保守

- **調査結果は定期的に更新する**
  - 機能の変更があった場合
  - 新しい情報が判明した場合

- **不確実な情報は明記する**
  - 「推測」「可能性がある」などの表現を使用
  - 確認が必要な項目は「要確認」ラベルを付ける
